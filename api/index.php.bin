<?php

	header('Access-Control-Allow-Origin: *');
	header('Access-Control-Allow-Headers: *, Authorization');
	header('Access-Control-Allow-Methods: *');
	header('Access-Control-Allow-Credentials: true');

	// сюда приходят все запросы. И все будет обрабатываться здесь
	header('Content-Type: application/json; charset=utf-8');
    
	require 'pgConnect.php';

	require './functions/FunctionsWork.php';
	require './functions/FunctionsAuthors.php';
	require './functions/FunctionsAuthorWorks.php';
	require './functions/FunctionsRead.php';
    require './functions/FunctionsFandom.php';
    require './functions/FunctionsCharacters.php';

    require './Authentification/Auth.php';
    require './Authentification/newAuth.php';
	
	$method = $_SERVER['REQUEST_METHOD'];
	
	$q = $_GET['q'];
	$params = explode('/' , $q);
	
	$type = $params[0];
	
	$statusFlag = false;
	
	// "http://fanlib-api.ru/works/"

    // function do_echo($echo) {
    //     echo $echo;
    // }
    
    // $functions = [
    //   'function1' => 'do_echo'
    // ];

    // $functions['function1']('aaa');


	if ($type == "works"){
		// запросы на вывод общего списка работ
		$SelectionType = $params[1];

		// echo $SelectionType;
		if (isset($SelectionType))
		{
            // новые работы
			if ($SelectionType == "new"){
				$statusFlag = true;
				GetIDNewWorks($db); // запрос на вывод списка ID новых добавленных работ
                return;
			}

            // одна работа
			if ($SelectionType == "one"){
				$statusFlag = true;
				$WorkID = $params[2];

                if (!isset($params[3]))
                {
				    GetWorkByID($db, $WorkID); // запрос на вывод инфы об одной работе
                    return;
                }
                else
                {
                    if ($params[3] == "chapters")
                        GetChaptersByWorkId($db, $WorkID);
                        return;
                }
			}

            // работы написанные в рамках фандома
            if ($SelectionType == "fromFandom"){

                if (isset($params[2]))
                {
                    $statusFlag = true;
                    $FandomID = $params[2];
                    echo $SelectionType.$FandomID;
                    return;
                }
            }

            if ($SelectionType == "onAuthor") {
                $statusFlag = true;
				$WorkID = $params[2];
                WorkAuthorExist($db, $params[3], $WorkID); // запрос автором информации о работе
                return;
            }
		}
	}
	else if ($type == "AuthorWorks"){
		// Запросы на вывод работ конкретного автора

		$UserID = $params[1];
		$SelectionType = $params[2];

		// http://fanlib-api.ru/AuthorWorks/id
		if (isset($UserID))
		{
			// вывод последних работ автора
			if ($SelectionType == "last"){
				$statusFlag = true;
				GetAuthorWorksLast($db, $UserID);
                return;
			}
		}

	}
	else if ($type == "users"){
		// запросы на вывод пользователей
		$SelectionType = $params[1];

		if ($SelectionType == "new")
		{
			$statusFlag = true;
			GetNewAuthors($db); // запрос на вывод списка новых авторов
            return;
		}

		if ($SelectionType == "one")
		{
			$statusFlag = true;
			$UserID = $params[2];
			GetOneAuthor($db,$UserID,false); // запрос на вывод списка новых авторов
            return;
		}
	}
	else if ($type == "read"){
		// запросы на получение информации о фанфике с главами

		$WorkId = intval($params[1]);

		if (isset($WorkId))
		{
			$statusFlag = true;

            if (count($params) > 2)
                $secondType = $params[2];
            
            if (!isset($secondType)){
			    GetWorkInfoByID($db, $WorkId);
                return;
            }
            else {
                if ($secondType == "chapter")
                {
                    $ChapterId = $params[3];
                    // echo $WorkId;
                    // echo $ChapterId;
                    GetChapterInfoById($db, $ChapterId, $WorkId);
                    return;
                }
                else
                {
                    GetWorkCommentsById($db, $WorkId);
                    return;
                }
            }
		}
	}
    else if ($type == "fandom"){

        $SelectionType = $params[1];

        if (str_contains($SelectionType, "search")){
            $statusFlag = true;
            // echo $_GET['name']; // Outputs: value1
            SearchForFandom($db, $_GET['name']);
            return;
            // echo $SelectionType;
        }

        if ($SelectionType == "one"){
            $FandomId = $params[2];

            if (!isset($params[3]))
            {
                $statusFlag = true;
                GetFandomInfoById($db, $FandomId);
            }            
        }
    }
    else if ($type == "characters"){
        $SelectionType = $params[1];
        
        if ($SelectionType == "fromfandom")
        {
            $statusFlag = true;
            $FandomId = $params[2];
            GetCharactersFromFandomById($db, $FandomId);
            return;
        }
    }
    else if ($type == "update") {
        $UpdateType = $params[1];

        if ($UpdateType == "work") {
            $statusFlag = true;
            
            $params = [];
            $params[] = $_GET['user_id']; // id пользователя     0
            $params[] = $_GET['work_id']; // id работы           1
            $params[] = $_GET['about']; // описание работы       2
            $params[] = $_GET['name']; // название работы        3
            $params[] = $_GET['remark']; // пометка автора       4

            UpdateWork($db, $params);
            return;
        }

        if ($UpdateType == "chapter") {
            $statusFlag = true;
            
            $entityBody = json_decode(file_get_contents('php://input'), true);
            $text = $entityBody[0]["chapter_text"];

            UpdateChapter($db, $_GET , $entityBody[0]["chapter_text"]);
            return;
        }
    }
    else if ($type == "insert") {
        $InsertType = $params[1];

        if ($InsertType == "comment") {
            $statusFlag = true;

            $params = [];
            $params[] = $_GET['user_id']; // id пользователя     0
            $params[] = $_GET['work_id']; // id работы           1
            $params[] = $_GET['commenttext']; // название работы        2

            AddComment($db, $params);
            return;
        }

        if ($InsertType == "chapter") {
            $statusFlag = true;

            AddChapter($db, $_GET);
            return;
        }
    }
    else if ($type == "user"){
        $QuerryType = $params[1];

        if (isset($QuerryType))
        {
            $key = ''.$type.'/'.$QuerryType.'';

            if (array_key_exists($key, $loginFunctions))
            {
                $loginFunctions[''.$type.'/'.$QuerryType.'']($db, $_GET);
                $statusFlag = true;
            }
            
        }
    }
	


	
	if (!$statusFlag) {
		http_response_code(404);

		$res = [
			"status" => false,
			"message" => "Error addres"
		];
		
		echo json_encode($res);
	}
?>

