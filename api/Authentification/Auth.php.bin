<?php

function CheckUser($db, $login, $password){
    // echo $login.$password;

    $result = pg_query($db, 'SELECT user_id, nickname FROM "public"."USER" WHERE email=\''.$login.'\' AND password= \''.md5($password).'\'');
    // $result = pg_query($db, 'SELECT user_id, nickname FROM "public"."USER" WHERE email=\''.$login.'\'');

    if (pg_num_rows($result) == 1)
    {
        $result_list = pg_fetch_assoc($result);
        $result_list += array("status" => true);

        // while ($answer = pg_fetch_assoc($result)) {
        //     $result_list[] = $answer;
        // }
        
        echo json_encode($result_list);
    }
    else
    {
        $result_list = array("status" => false,"Error" => "Cant find user");
                        
        echo json_encode($result_list);
    }
}

function registerUser($db, $login, $password, $nickname) {
    $result = pg_query($db, 'SELECT user_id, nickname FROM "public"."USER" WHERE email=\''.$login.'\'');

    if (pg_num_rows($result) > 0) {
        $result_list = ["status" => false,
                        "Message" => "Email already used"];
        echo json_encode($result_list);
    }
    else {
        $result = pg_query($db, 'SELECT user_id FROM "public"."USER" ORDER BY user_id DESC LIMIT 1');

        $new_id = pg_fetch_assoc($result)['user_id'] + 1;


        // добавление пользователя в базу данных
        $query = 'INSERT INTO "public"."USER" (user_id, birth, about, email, password, nickname) VALUES ($1, $2, $3, $4, $5, $6)';
	    $result = pg_query_params($db, $query, array($new_id, NULL, NULL,$login, md5($password), $nickname));

        $state = pg_result_error($result);  //  отлов ошибок выполнения запроса

        if (empty($state))
        {
            $result_list = ["status" => true,
                            "Message" => "Register complete"];
            echo json_encode($result_list);
        }
        else
        {
            $result_list = ["status" => false,
                            "Message" => $state];
            echo json_encode($result_list);
        }
    }
}


?>